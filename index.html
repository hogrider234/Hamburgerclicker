<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Burger Capitalism - 0 burgers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        :root {
            --bg-dark: #0f1014;
            --bg-panel: rgba(24, 26, 35, 0.96);
            --accent: #ff9f43;
            --accent-strong: #ff6b1a;
            --accent-alt: #42a5f5;
            --text-main: #f8f3e7;
            --text-muted: #a7a9b7;
            --border-subtle: rgba(255,255,255,0.06);
            --radius-lg: 14px;
            --radius-md: 10px;
            --radius-sm: 6px;
            --shadow-soft: 0 12px 35px rgba(0,0,0,0.65);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #252a3d, #05060a 55%);
            color: var(--text-main);
            text-align: center;
        }

        #gameContainer {
            display: grid;
            grid-template-columns: minmax(280px, 380px) minmax(320px, 460px) minmax(320px, 420px);
            gap: 18px;
            padding: 18px;
            max-width: 1320px;
            margin: 0 auto;
        }

        @media (max-width: 1100px) {
            #gameContainer {
                grid-template-columns: minmax(280px, 420px) minmax(320px, 460px);
                grid-template-rows: auto;
            }
        }

        @media (max-width: 880px) {
            #gameContainer {
                grid-template-columns: minmax(280px, 1fr);
            }
        }

        section {
            background: var(--bg-panel);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            padding: 14px 14px 16px;
            text-align: left;
        }

        h1, h2, h3 {
            margin: 0 0 8px;
            font-weight: 600;
        }

        h1 {
            font-size: 22px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            text-align: center;
            color: #ffe082;
        }

        h2 {
            font-size: 18px;
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: 4px;
        }

        h3 {
            font-size: 15px;
            color: var(--text-muted);
        }

        p {
            margin: 4px 0;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* Player / burger column */

        #playerSection {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #usernameRow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            font-size: 13px;
        }

        #usernameInput {
            flex: 1;
            font-size: 13px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-subtle);
            padding: 4px 8px;
            background: #11131b;
            color: var(--text-main);
        }

        /* Skill Tree Overlay */
        #skillTreeOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(10, 11, 16, 0.98);
            z-index: 1000;
            padding: 40px;
            flex-direction: column;
            align-items: center;
        }

        .skill-tree-container {
            display: flex;
            flex-direction: column;
            gap: 40px;
            margin-top: 50px;
        }

        .skill-row {
            display: flex;
            gap: 30px;
            justify-content: center;
        }
c

        .orbit-spatula {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: radial-gradient(circle at 20% 20%, #ffffff, #d4d4d4);
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -13px;
            margin-left: -13px;
            box-shadow: 0 0 10px rgba(255,255,255,0.7);
        }

        .orbit-spatula::before {
            content: "";
            position: absolute;
            width: 6px;
            height: 18px;
            background: linear-gradient(#888, #444);
            border-radius: 4px;
            top: 5px;
            left: 10px;
        }

        #statsPanel {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            font-size: 12px;
        }

        .stat-pill {
            flex: 1 1 110px;
            padding: 6px 8px;
            border-radius: 999px;
            background: rgba(0,0,0,0.35);
            border: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            color: var(--text-muted);
        }

        .stat-value {
            font-weight: 600;
            color: #ffe082;
        }

        #burgerCount {
            font-size: 22px;
            margin-top: 6px;
            text-align: center;
        }

        #comboDisplay {
            font-weight: 600;
            color: var(--accent-alt);
        }

        #bossRaidProgressBar {
            margin-top: 6px;
        }

        .progress-bar {
            width: 100%;
            background: #181926;
            border-radius: 999px;
            height: 10px;
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #42a5f5, #29b6f6);
            transition: width 0.2s ease;
        }

        .btn-row {
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .btn {
            padding: 6px 10px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #141414;
            box-shadow: 0 3px 10px rgba(0,0,0,0.45);
            transition: transform 0.06s ease, box-shadow 0.12s ease, background 0.15s ease;
            white-space: nowrap;
        }

        .btn:hover:not(.disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.6);
        }

        .btn:active:not(.disabled) {
            transform: translateY(1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.65);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #4b5563, #111827);
            color: #e5e7eb;
        }

        .btn.disabled {
            background: #4b4f5f;
            color: #a3a5b5;
            cursor: not-allowed;
            box-shadow: none;
        }

        #saveCode, #cloudSlotDisplay {
            width: 100%;
            min-height: 58px;
            margin-top: 6px;
            font-size: 11px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-subtle);
            background: #05060a;
            color: var(--text-main);
            padding: 6px 8px;
            resize: vertical;
        }

        /* Shop column */

        #shopItems {
            max-height: 460px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .shop-item {
            border-bottom: 1px solid var(--border-subtle);
            padding: 6px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 12px;
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
        }

        .item-count {
            color: var(--text-muted);
            font-size: 11px;
        }

        .item-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        #goldenUpgradeHint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Right column */

        #upgradesSectionInner {
            margin-bottom: 10px;
        }

        #bossSection {
            margin-top: 6px;
        }

        #bossStatus {
            font-size: 12px;
            margin: 2px 0 4px;
        }

        #bossHealthBarContainer {
            width: 100%;
            background: #181926;
            border-radius: 999px;
            overflow: hidden;
            height: 14px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
        }

        #bossHealthBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ef4444, #f97316);
            transition: width 0.1s linear;
        }

        #achievementsList {
            max-height: 180px;
            overflow-y: auto;
            font-size: 11px;
            margin-top: 4px;
        }

        .achievement {
            padding: 3px 0;
            border-bottom: 1px dashed var(--border-subtle);
            color: var(--text-muted);
        }

        .achievement.unlocked {
            color: #ffe082;
        }

        #skillTree .skill-node {
            border-bottom: 1px solid var(--border-subtle);
            padding: 6px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        #leaderboardList {
            max-height: 130px;
            overflow-y: auto;
            font-size: 11px;
            margin-top: 4px;
        }

        .leaderboard-entry {
            padding: 2px 0;
        }

        /* Particles & golden burger */

        #particlesContainer {
            pointer-events: none;
            position: fixed;
            inset: 0;
            overflow: hidden;
            z-index: 30;
        }

        .particle {
            position: absolute;
            font-size: 18px;
            animation: floatUp 0.6s ease-out forwards;
            text-shadow: 0 0 6px rgba(0,0,0,0.7);
        }

        .golden-particle {
            animation: goldenFlash 0.9s ease-out forwards;
        }

        .upgrade-particle {
            animation: floatUp 0.9s ease-out forwards;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(0.82); }
        }

        @keyframes goldenFlash {
            0% { opacity: 0; transform: scale(0.5); text-shadow: 0 0 4px #ffef9f; }
            40% { opacity: 1; transform: scale(1.15); text-shadow: 0 0 12px #ffe36b; }
            100% { opacity: 0; transform: scale(0.85); text-shadow: 0 0 2px #ccaa44; }
        }

        .golden-burger-popup {
            position: fixed;
            right: 16px;
            top: 76px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff9c4, #ffca28);
            box-shadow: 0 0 22px rgba(255, 215, 0, 0.9);
            cursor: pointer;
            animation: goldenPulse 1.5s infinite;
            z-index: 40;
        }

        @keyframes goldenPulse {
            0% { transform: scale(1); box-shadow: 0 0 10px rgba(255,215,0,0.55); }
            50% { transform: scale(1.1); box-shadow: 0 0 24px rgba(255,215,0,1); }
            100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,215,0,0.55); }
        }

        @media (max-width: 600px) {
            #burger {
                width: 170px;
                height: 130px;
            }
            #spatulaOrbitCanvas {
                width: 220px;
                height: 200px;
            }
            h1 {
                font-size: 19px;
            }
            #burgerCount {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
<div id="particlesContainer"></div>

<div id="gameContainer">
    <!-- Player / burger column -->
    <section id="playerSection">
        <div id="usernameRow">
            <span>Player</span>
            <input id="usernameInput" placeholder="Enter a name">
        </div>
        <h1>Capitalism but tasty.</h1>

        <div id="burgerDisplayWrap">
            <div id="spatulaOrbitCanvas">
                <div id="burger">
                    <div id="burgerEmojiOverlay" style="opacity: 1;">üçî</div>
                </div>
            </div>

            <div id="burgerCount">0 burgers</div>

            <div id="statsPanel">
                <div class="stat-pill">
                    <span class="stat-label">Per Click</span>
                    <span id="bpcDisplay" class="stat-value">1</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-label">Per Second</span>
                    <span id="bpsDisplay" class="stat-value">0</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-label">Prestige</span>
                    <span id="prestigeDisplay" class="stat-value">x1.00</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-label">Combo</span>
                    <span id="comboDisplay" class="stat-value">x1.0</span>
                </div>
            </div>

            <div id="bossRaidProgressBar">
                <div class="progress-bar">
                    <div id="bossRaidProgress" class="progress-fill"></div>
                </div>
                <p>Boss raid charge from total production.</p>
            </div>

    <div class="btn-row">
        <button id="prestigeButton" class="btn disabled">Ascend (+25% global)</button>
    
        <button class="btn" onclick="document.getElementById('skillTreeOverlay').style.display='flex'" style="background: linear-gradient(135deg, #6366f1, #4338ca); margin-left: 5px;">
            View Skill Tree
        </button>
    </div>

    <div class="btn-row" style="margin-top:10px;">
        <button id="saveButton" class="btn secondary">Save</button>
        <button id="exportButton" class="btn secondary">Export</button>
        <button id="importButton" class="btn secondary">Import</button>
    
        <button id="restartButton" class="btn secondary" style="background: linear-gradient(135deg, #ff4b2b, #ff416c); color: white; margin-left: auto;">
            Restart Progress
        </button>
    </div>
        <textarea id="saveCode" placeholder="Exported save code appears here"></textarea>
    </section>

    <!-- Shop column -->
    <section id="shopSection">
        <h2>Shop</h2>
        <p>Invest in better tools, automation, and late‚Äëgame reactors.</p>

        <div id="shopItems">
            <!-- existing and new shop items -->
            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Spatula (+1 per click)</div>
                    <div class="item-count" id="spatulaCount">Owned: 0</div>
                </div>
                <button id="buySpatula" class="btn">Buy (10)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Grill Bot (+1 per second)</div>
                    <div class="item-count" id="grillBotCount">Owned: 0</div>
                </div>
                <button id="buyGrillBot" class="btn">Buy (25)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">AI Chef (Boosts production)</div>
                    <div class="item-count" id="aiChefCount">Owned: 0</div>
                </div>
                <button id="buyAIChef" class="btn">Buy (150)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Golden Bun (+5 per click)</div>
                    <div class="item-count" id="goldenBunCount">Owned: 0</div>
                </div>
                <button id="buyGoldenBun" class="btn">Buy (200)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Delivery Drone (+5 per second)</div>
                    <div class="item-count" id="deliveryDroneCount">Owned: 0</div>
                </div>
                <button id="buyDeliveryDrone" class="btn">Buy (250)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Turbo Grill (+10 per second)</div>
                    <div class="item-count" id="turboGrillCount">Owned: 0</div>
                </div>
                <button id="buyTurboGrill" class="btn">Buy (600)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Super Spatula (+3 per click)</div>
                    <div class="item-count" id="superSpatulaCount">Owned: 0</div>
                </div>
                <button id="buySuperSpatula" class="btn">Buy (800)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Mega Burger (+50 per click)</div>
                    <div class="item-count" id="megaBurgerCount">Owned: 0</div>
                </div>
                <button id="buyMegaBurger" class="btn">Buy (3,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">AI Assistant (+10% auto)</div>
                    <div class="item-count" id="aiAssistantCount">Owned: 0</div>
                </div>
                <button id="buyAIAssistant" class="btn">Buy (5,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Golden Grill (+25 per second)</div>
                    <div class="item-count" id="goldenGrillCount">Owned: 0</div>
                </div>
                <button id="buyGoldenGrill" class="btn">Buy (9,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Delivery Fleet (+25 per second)</div>
                    <div class="item-count" id="deliveryFleetCount">Owned: 0</div>
                </div>
                <button id="buyDeliveryFleet" class="btn">Buy (12,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Mutation Serum (Random boost)</div>
                    <div class="item-count" id="mutationSerumCount">Owned: 0</div>
                </div>
                <button id="buyMutationSerum" class="btn">Buy (15,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Boss Summoner</div>
                    <div class="item-meta">Summon a boss immediately</div>
                </div>
                <button id="buyBossSummoner" class="btn">Buy (20,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Prestige Token</div>
                    <div class="item-meta">Boost permanent multiplier</div>
                </div>
                <button id="buyPrestigeToken" class="btn">Buy (50,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Golden Mutation (+5 per click)</div>
                    <div class="item-count" id="goldenMutationCount">Owned: 0</div>
                </div>
                <button id="buyGoldenMutation" class="btn">Buy (75,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Quantum Grill (+100 per second)</div>
                    <div class="item-count" id="quantumGrillCount">Owned: 0</div>
                </div>
                <button id="buyQuantumGrill" class="btn">Buy (150,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Hyper Spatula (+25 per click)</div>
                    <div class="item-count" id="hyperSpatulaCount">Owned: 0</div>
                </div>
                <button id="buyHyperSpatula" class="btn">Buy (200,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Cosmic Drone Fleet (+200 per second)</div>
                    <div class="item-count" id="cosmicDroneCount">Owned: 0</div>
                </div>
                <button id="buyCosmicDrone" class="btn">Buy (400,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Galactic Bun (+250 per click)</div>
                    <div class="item-count" id="galacticBunCount">Owned: 0</div>
                </div>
                <button id="buyGalacticBun" class="btn">Buy (600,000)</button>
            </div>

            <!-- Late‚Äëgame items -->
            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Burger Reactor (+500 per second)</div>
                    <div class="item-count" id="burgerReactorCount">Owned: 0</div>
                </div>
                <button id="buyBurgerReactor" class="btn">Buy (1,000,000)</button>
            </div>

            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Nano Spatula (+200 per click)</div>
                    <div class="item-count" id="nanoSpatulaCount">Owned: 0</div>
                </div>
                <button id="buyNanoSpatula" class="btn">Buy (1,500,000)</button>
            </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">Fusion Grill (+2.5K BPS)</div>
                <div class="item-count" id="fusionGrillCount">Owned: 0</div>
            </div>
            <button id="buyFusionGrill" class="btn">Buy (5M)</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">Antimatter Bun (+1K BPC)</div>
                <div class="item-count" id="antimatterBunCount">Owned: 0</div>
            </div>
            <button id="buyAntimatterBun" class="btn">Buy (15M)</button>
        </div>

        <div class="shop-item">
             <div class="item-info">
                <div class="item-title">Orbital Kitchen (+12K BPS)</div>
                <div class="item-count" id="orbitalKitchenCount">Owned: 0</div>
            </div>
            <button id="buyOrbitalKitchen" class="btn">Buy (50M)</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">Time Fryer (+5K BPC)</div>
                <div class="item-count" id="timeFryerCount">Owned: 0</div>
            </div>
            <button id="buyTimeFryer" class="btn">Buy (150M)</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">Black Hole Oven (+65K BPS)</div>
                <div class="item-count" id="blackHoleOvenCount">Owned: 0</div>
            </div>
            <button id="buyBlackHoleOven" class="btn">Buy (500M)</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">Nebula Spatula (+25K BPC)</div>
                <div class="item-count" id="nebulaSpatulaCount">Owned: 0</div>
            </div>
            <button id="buyNebulaSpatula" class="btn">Buy (1B)</button>
        </div>

        <div class="shop-item">
        <div class="item-info">
                <div class="item-title">Dimension Ketchup (+350K BPS)</div>
                <div class="item-count" id="dimensionKetchupCount">Owned: 0</div>
            </div>
            <button id="buyDimensionKetchup" class="btn">Buy (5B)</button>
        </div>

        <div class="shop-item">
        <div class="item-info">
                <div class="item-title">Quantum Cow (+120K BPC)</div>
                <div class="item-count" id="quantumCowCount">Owned: 0</div>
            </div>
            <button id="buyQuantumCow" class="btn">Buy (15B)</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">Galaxy Drive-Thru (+2M BPS)</div>
                <div class="item-count" id="galaxyDriveThruCount">Owned: 0</div>
            </div>
            <button id="buyGalaxyDriveThru" class="btn">Buy (50B)</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">Star Dust Seasoning (+600K BPC)</div>
                <div class="item-count" id="starDustSeasonCount">Owned: 0</div>
            </div>
            <button id="buyStarDustSeason" class="btn">Buy (120B)</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">Void Meat (+8M BPS)</div>
                <div class="item-count" id="voidMeatCount">Owned: 0</div>
            </div>
            <button id="buyVoidMeat" class="btn">Buy (250B)</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">Infinity Grill (+2M BPC)</div>
                <div class="item-count" id="infinityGrillCount">Owned: 0</div>
            </div>
            <button id="buyInfinityGrill" class="btn">Buy (450B)</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">Universal Chef (+25M BPS)</div>
                <div class="item-count" id="universalChefCount">Owned: 0</div>
            </div>
            <button id="buyUniversalChef" class="btn">Buy (650B)</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">Reality Bake (+10M BPC)</div>
                <div class="item-count" id="realityBakeCount">Owned: 0</div>
            </div>
            <button id="buyRealityBake" class="btn">Buy (850B)</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-title">CAPITALISM GOD (+50M BPC & BPS)</div>
                <div class="item-count" id="capitalismGodCount">Owned: 0</div>
            </div>
            <button id="buyCapitalismGod" class="btn">Buy (1T)</button>
        </div>

            <!-- Golden spawn upgrade -->
            <div class="shop-item">
                <div class="item-info">
                    <div class="item-title">Golden Radar (+10% golden spawn)</div>
                    <div class="item-count" id="goldenRadarCount">Owned: 0</div>
                    <div class="item-meta">Makes golden burgers appear more often.</div>
                </div>
                <button id="buyGoldenRadar" class="btn">Buy (2,000,000)</button>
            </div>
        </div>

        <p id="goldenUpgradeHint">Golden burgers spawn randomly over time; Radar upgrades speed that up.</p>
    </section>

    <!-- Right column: upgrades / boss / achievements / skills / cloud / leaderboard -->
    <section id="sideSection">
        <div id="upgradesSectionInner">
            <h2>Upgrades & Boss</h2>
            <div id="upgrades">
                <p>Click Combo: <span id="comboDisplayText"><span id="comboDisplayInline">x1.0</span></span></p>
                <p>Offline earnings apply while you are away.</p>
            </div>

            <div id="bossSection">
                <h3>Boss / Raid</h3>
                <div id="bossStatus">No boss currently.</div>
                <div id="bossHealthBarContainer">
                    <div id="bossHealthBar"></div>
                </div>
                <div class="btn-row" style="margin-top:6px;">
                    <button id="forceBossButton" class="btn secondary">Summon Boss</button>
                </div>
            </div>
        </div>

        <div id="achievementsSection">
            <h3>Achievements</h3>
            <div id="achievementsList">
                <!-- Filled in by JS -->
            </div>
        </div>

        

        <div id="cloudSection" style="margin-top:10px;">
            <h3>Cloud Mirror</h3>
            <p>Local CLOUD_SLOT save mirror.</p>
            <div class="btn-row">
                <button id="cloudSaveButton" class="btn secondary">Cloud Save</button>
                <button id="cloudLoadButton" class="btn secondary">Cloud Load</button>
            </div>
            <textarea id="cloudSlotDisplay" readonly placeholder="Cloud payload preview"></textarea>
        </div>

        <div id="leaderboardSection" style="margin-top:10px;">
            <h3>Local Leaderboard</h3>
            <div id="leaderboardList"></div>
        </div>
    </section>
    </div>


    <div id="skillTreeOverlay">
        <h1 style="color: var(--accent);">Burger Evolution Tree</h1>
        <div class="skill-tree-container">
            <div class="skill-row">
                <div class="skill-node-v2" id="skill-greasyFingers" onclick="buySkill('greasyFingers')">
                    <b>Greasy Fingers</b><br>+5% Click<br>(2k)
                </div>
                <div class="skill-node-v2" id="skill-industrialFans" onclick="buySkill('industrialFans')">
                    <b>Industrial Fans</b><br>+5% Auto<br>(2k)
                </div>
            </div>
        <div class="skill-row">
            <div class="skill-node-v2" id="skill-extraPickles" onclick="buySkill('extraPickles')">
                <b>Extra Pickles</b><br>+10% Click<br>(10k)
            </div>
            <div class="skill-node-v2" id="skill-conveyorBelt" onclick="buySkill('conveyorBelt')">
                <b>Conveyor Belt</b><br>+15% Auto<br>(25k)
            </div>
        </div>
    </div>
    <button class="btn secondary" onclick="document.getElementById('skillTreeOverlay').style.display='none'">Close Tree</button>
</div>
<script>
(() => {
    // -------- Core state --------
    let burgers = 0;
    let totalBurgersEver = 0;
    let burgersPerClickBase = 1;
    let burgersPerSecondBase = 0;

    const shopState = {
        spatula:       {count: 0, cost: 10,        bpc: 1,   bps: 0,   costScale: 1.15},
        grillBot:      {count: 0, cost: 25,        bpc: 0,   bps: 1,   costScale: 1.15},
        aiChef:        {count: 0, cost: 150,       bpc: 0,   bps: 0,   costScale: 1.18},
        goldenBun:     {count: 0, cost: 200,       bpc: 5,   bps: 0,   costScale: 1.18},
        deliveryDrone: {count: 0, cost: 250,       bpc: 0,   bps: 5,   costScale: 1.18},
        turboGrill:    {count: 0, cost: 600,       bpc: 0,   bps: 10,  costScale: 1.18},
        superSpatula:  {count: 0, cost: 800,       bpc: 3,   bps: 0,   costScale: 1.20},
        megaBurger:    {count: 0, cost: 3000,      bpc: 50,  bps: 0,   costScale: 1.22},
        aiAssistant:   {count: 0, cost: 5000,      bpc: 0,   bps: 0,   costScale: 1.25},
        goldenGrill:   {count: 0, cost: 9000,      bpc: 0,   bps: 25,  costScale: 1.22},
        deliveryFleet: {count: 0, cost: 12000,     bpc: 0,   bps: 25,  costScale: 1.22},
        mutationSerum: {count: 0, cost: 15000,     bpc: 0,   bps: 0,   costScale: 1.30},
        bossSummoner:  {count: 0, cost: 20000,     bpc: 0,   bps: 0,   costScale: 1.30},
        prestigeToken: {count: 0, cost: 50000,     bpc: 0,   bps: 0,   costScale: 1.40},
        goldenMutation:{count: 0, cost: 75000,     bpc: 5,   bps: 0,   costScale: 1.25},
        quantumGrill:  {count: 0, cost: 150000,    bpc: 0,   bps: 100, costScale: 1.25},
        hyperSpatula:  {count: 0, cost: 200000,    bpc: 25,  bps: 0,   costScale: 1.25},
        cosmicDrone:   {count: 0, cost: 400000,    bpc: 0,   bps: 200, costScale: 1.25},
        galacticBun:   {count: 0, cost: 600000,    bpc: 250, bps: 0,   costScale: 1.30},
        burgerReactor: {count: 0, cost: 1000000,   bpc: 0,   bps: 500, costScale: 1.30},
        nanoSpatula:   {count: 0, cost: 1500000,   bpc: 200, bps: 0,   costScale: 1.30},
        goldenRadar:   {count: 0, cost: 200000,    bpc: 0,   bps: 0,   costScale: 1.40}

        // --- 15 NEW ITEMS ---
        fusionGrill:   {count: 0, cost: 5000000,   bpc: 0,   bps: 2500,  costScale: 1.25},
        antimatterBun: {count: 0, cost: 15000000,  bpc: 1000, bps: 0,     costScale: 1.28},
        orbitalKitchen:{count: 0, cost: 50000000,  bpc: 0,   bps: 12000, costScale: 1.25},
        timeFryer:     {count: 0, cost: 150000000, bpc: 5000, bps: 0,     costScale: 1.30},
        blackHoleOven: {count: 0, cost: 500000000, bpc: 0,   bps: 65000, costScale: 1.25},
        nebulaSpatula: {count: 0, cost: 1000000000,bpc: 25000, bps: 0,    costScale: 1.35},
        dimensionKetchup:{count: 0, cost: 5000000000, bpc: 0, bps: 350000, costScale: 1.25},
        quantumCow:    {count: 0, cost: 15000000000, bpc: 120000, bps: 0,  costScale: 1.30},
        galaxyDriveThru:{count: 0, cost: 50000000000, bpc: 0, bps: 2000000, costScale: 1.25},
        starDustSeason:{count: 0, cost: 120000000000, bpc: 600000, bps: 0, costScale: 1.35},
        voidMeat:      {count: 0, cost: 250000000000, bpc: 0, bps: 8000000, costScale: 1.25},
        infinityGrill: {count: 0, cost: 450000000000, bpc: 2000000, bps: 0, costScale: 1.30},
        universalChef: {count: 0, cost: 650000000000, bpc: 0, bps: 25000000, costScale: 1.25},
        realityBake:   {count: 0, cost: 850000000000, bpc: 10000000, bps: 0, costScale: 1.35},
        capitalismGod: {count: 0, cost: 1000000000000, bpc: 50000000, bps: 50000000, costScale: 1.40}
    };

    const skillTreeState = {
        greasyFingers:   {purchased: false, cost: 2000, clickBonus: 0.05, autoBonus: 0},
        industrialFans:  {purchased: false, cost: 2000, clickBonus: 0,    autoBonus: 0.05},
        assemblyLine:    {purchased: false, cost: 4000, clickBonus: 0,    autoBonus: 0.10},
        // ADD THESE TO MATCH YOUR OVERLAY:
        extraPickles:    {purchased: false, cost: 10000, clickBonus: 0.10, autoBonus: 0},
        conveyorBelt:    {purchased: false, cost: 25000, clickBonus: 0,    autoBonus: 0.15}
    };
    const achievements = [
        {id: "burgers_100",   name: "Hundred Buns",     desc: "Reach 100 burgers.",        unlocked: false},
        {id: "burgers_1k",    name: "Thousand Stack",   desc: "Reach 1,000 burgers.",      unlocked: false},
        {id: "burgers_100k",  name: "Sesame Tycoon",    desc: "Reach 100,000 burgers.",    unlocked: false},
        {id: "bpc_100",       name: "Finger of Gold",   desc: "Reach 100 burgers/click.",  unlocked: false},
        {id: "bps_1k",        name: "Eternal Grill",    desc: "Reach 1,000 burgers/sec.",  unlocked: false},
        {id: "ascend_1",      name: "First Ascension",  desc: "Ascend once.",              unlocked: false},
        {id: "boss_1",        name: "First Raid",       desc: "Defeat a boss.",            unlocked: false}
    ];

    // Combo
    let comboCount = 0;
    let lastClickTime = 0;
    let comboMultiplier = 1;

    // Prestige
    let prestigeAscensions = 0;
    let prestigeMultiplier = 1;

    // AI Assistants
    let aiAssistantBonus = 0;

    // Boss / raid
    let bossActive = false;
    let bossHealth = 0;
    let bossMaxHealth = 0;
    let bossRaidProgress = 0;
    let bossRaidThreshold = 5000;

    // Golden burger timing
    let goldenBaseMinDelay = 30000;  // 30s
    let goldenBaseMaxDelay = 120000; // 120s
    let goldenSpawnMultiplier = 1;   // improved by Golden Radar (10% per)
    let nextGoldenSpawnTime = Date.now() + getRandomGoldenDelay();

    // Offline
    let lastTickTime = Date.now();
    let lastOfflineTimestamp = Date.now();

    // User
    let username = "";

    // DOM shortcuts
    const burgerEl           = document.getElementById("burger");
    const burgerCountEl      = document.getElementById("burgerCount");
    const bpcDisplayEl       = document.getElementById("bpcDisplay");
    const bpsDisplayEl       = document.getElementById("bpsDisplay");
    const prestigeDisplayEl  = document.getElementById("prestigeDisplay");
    const comboDisplayEl     = document.getElementById("comboDisplay");
    const comboDisplayInline = document.getElementById("comboDisplayInline");
    const bossStatusEl       = document.getElementById("bossStatus");
    const bossHealthBarEl    = document.getElementById("bossHealthBar");
    const bossRaidProgressEl = document.getElementById("bossRaidProgress");
    const particlesContainer = document.getElementById("particlesContainer");
    const usernameInput      = document.getElementById("usernameInput");
    const prestigeButton     = document.getElementById("prestigeButton");
    const leaderboardList    = document.getElementById("leaderboardList");
    const burgerEmojiOverlay = document.getElementById("burgerEmojiOverlay");

    // Map button IDs to shop keys
    const buttonMap = {
        buySpatula:       "spatula",
        buyGrillBot:      "grillBot",
        buyAIChef:        "aiChef",
        buyGoldenBun:     "goldenBun",
        buyDeliveryDrone: "deliveryDrone",
        buyTurboGrill:    "turboGrill",
        buySuperSpatula:  "superSpatula",
        buyMegaBurger:    "megaBurger",
        buyAIAssistant:   "aiAssistant",
        buyGoldenGrill:   "goldenGrill",
        buyDeliveryFleet: "deliveryFleet",
        buyMutationSerum: "mutationSerum",
        buyBossSummoner:  "bossSummoner",
        buyPrestigeToken: "prestigeToken",
        buyGoldenMutation:"goldenMutation",
        buyQuantumGrill:  "quantumGrill",
        buyHyperSpatula:  "hyperSpatula",
        buyCosmicDrone:   "cosmicDrone",
        buyGalacticBun:   "galacticBun",
        buyBurgerReactor: "burgerReactor",
        buyNanoSpatula:   "nanoSpatula",
        buyGoldenRadar:   "goldenRadar"
        buyFusionGrill: "fusionGrill",
        buyAntimatterBun: "antimatterBun",
        buyOrbitalKitchen: "orbitalKitchen",
        buyTimeFryer: "timeFryer",
        buyBlackHoleOven: "blackHoleOven",
        buyNebulaSpatula: "nebulaSpatula",
        buyDimensionKetchup: "dimensionKetchup",
        buyQuantumCow: "quantumCow",
        buyGalaxyDriveThru: "galaxyDriveThru",
        buyStarDustSeason: "starDustSeason",
        buyVoidMeat: "voidMeat",
        buyInfinityGrill: "infinityGrill",
        buyUniversalChef: "universalChef",
        buyRealityBake: "realityBake",
        buyCapitalismGod: "capitalismGod"
    };

    const countLabelMap = {
        spatula:       document.getElementById("spatulaCount"),
        grillBot:      document.getElementById("grillBotCount"),
        aiChef:        document.getElementById("aiChefCount"),
        goldenBun:     document.getElementById("goldenBunCount"),
        deliveryDrone: document.getElementById("deliveryDroneCount"),
        turboGrill:    document.getElementById("turboGrillCount"),
        superSpatula:  document.getElementById("superSpatulaCount"),
        megaBurger:    document.getElementById("megaBurgerCount"),
        aiAssistant:   document.getElementById("aiAssistantCount"),
        goldenGrill:   document.getElementById("goldenGrillCount"),
        deliveryFleet: document.getElementById("deliveryFleetCount"),
        mutationSerum: document.getElementById("mutationSerumCount"),
        goldenMutation:document.getElementById("goldenMutationCount"),
        quantumGrill:  document.getElementById("quantumGrillCount"),
        hyperSpatula:  document.getElementById("hyperSpatulaCount"),
        cosmicDrone:   document.getElementById("cosmicDroneCount"),
        galacticBun:   document.getElementById("galacticBunCount"),
        burgerReactor: document.getElementById("burgerReactorCount"),
        nanoSpatula:   document.getElementById("nanoSpatulaCount"),
        goldenRadar:   document.getElementById("goldenRadarCount")
        fusionGrill: document.getElementById("fusionGrillCount"),
        antimatterBun: document.getElementById("antimatterBunCount"),
        orbitalKitchen: document.getElementById("orbitalKitchenCount"),
        timeFryer: document.getElementById("timeFryerCount"),
        blackHoleOven: document.getElementById("blackHoleOvenCount"),
        nebulaSpatula: document.getElementById("nebulaSpatulaCount"),
        dimensionKetchup: document.getElementById("dimensionKetchupCount"),
        quantumCow: document.getElementById("quantumCowCount"),
        galaxyDriveThru: document.getElementById("galaxyDriveThruCount"),
        starDustSeason: document.getElementById("starDustSeasonCount"),
        voidMeat: document.getElementById("voidMeatCount"),
        infinityGrill: document.getElementById("infinityGrillCount"),
        universalChef: document.getElementById("universalChefCount"),
        realityBake: document.getElementById("realityBakeCount"),
        capitalismGod: document.getElementById("capitalismGodCount")
    };

    function formatNumber(n) {
        if(nn >= 1e12)return (n / 1e12).toFixed(2) + "T";
        if (n >= 1e9) return (n / 1e9).toFixed(2) + "B";
        if (n >= 1e6) return (n / 1e6).toFixed(2) + "M";
        if (n >= 1e3) return (n / 1e3).toFixed(2) + "K";
        return Math.floor(n).toString();
    }

    function updateTitleBar() {
        const name = username || "Guest";
        document.title = name + " - " + formatNumber(burgers) + " burgers";
    }

    // -------- Production calculation --------
    function calculateProduction() {
        let baseClick = burgersPerClickBase;
        let baseAuto  = burgersPerSecondBase;

        Object.values(shopState).forEach(item => {
            baseClick += item.bpc * item.count;
            baseAuto  += item.bps * item.count;
        });

        const aiAssistants = shopState.aiAssistant.count || 0;
        aiAssistantBonus = 0.10 * aiAssistants;
        baseAuto *= (1 + aiAssistantBonus);

        let clickSkillBonus = 0;
        let autoSkillBonus  = 0;
        Object.values(skillTreeState).forEach(skill => {
            if (skill.purchased) {
                clickSkillBonus += skill.clickBonus;
                autoSkillBonus  += skill.autoBonus;
            }
        });

        baseClick *= (1 + clickSkillBonus);
        baseAuto  *= (1 + autoSkillBonus);

        baseClick *= prestigeMultiplier;
        baseAuto  *= prestigeMultiplier;

        const finalClick = baseClick * comboMultiplier;
        return {bpc: finalClick, bps: baseAuto};
    }

    function updateDisplay() {
        const prod = calculateProduction();
        burgerCountEl.textContent = formatNumber(burgers) + " burgers";
        bpcDisplayEl.textContent  = prod.bpc.toFixed(2);
        bpsDisplayEl.textContent  = prod.bps.toFixed(2);
        prestigeDisplayEl.textContent = "x" + prestigeMultiplier.toFixed(2) + " (" + prestigeAscensions + ")";
        comboDisplayEl.textContent = "x" + comboMultiplier.toFixed(2);
        comboDisplayInline.textContent = "x" + comboMultiplier.toFixed(2);

        updateTitleBar();
        updateShopButtons();
        updatePrestigeButton();
        updateOrbitSpatulas();
        updateBossRaidProgress();
    }

    function updateShopButtons() {
        Object.entries(buttonMap).forEach(([btnId, key]) => {
            const button = document.getElementById(btnId);
            const item = shopState[key];
            if (!button || !item) return;

            const canAfford = burgers >= item.cost;
            button.textContent = "Buy (" + formatNumber(item.cost) + ")";
            if (canAfford) {
                button.classList.remove("disabled");
            } else {
                button.classList.add("disabled");
            }
        });

        Object.entries(skillTreeState).forEach(([key, skill]) => {
            const btnId =
                key === "greasyFingers"  ? "buySkillGreasyFingers" :
                key === "industrialFans" ? "buySkillIndustrialFans" :
                "buySkillAssemblyLine";

            const btn = document.getElementById(btnId);
            if (!btn) return;

            if (skill.purchased) {
                btn.textContent = "Unlocked";
                btn.classList.add("disabled");
            } else {
                btn.textContent = "Unlock (" + formatNumber(skill.cost) + ")";
                if (burgers >= skill.cost) {
                    btn.classList.remove("disabled");
                } else {
                    btn.classList.add("disabled");
                }
            }
        });
    }

    // -------- Particles & golden burger --------
    function spawnClickParticle(x, y) {
        const emojis = ["üçî", "‚ú¶"];
        const el = document.createElement("div");
        el.className = "particle";
        el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        el.style.left = x + "px";
        el.style.top  = y + "px";
        particlesContainer.appendChild(el);
        setTimeout(() => el.remove(), 700);
    }

    function spawnUpgradeParticle(x, y) {
        const emojis = ["‚ú®", "ü•Ø", "üç≥", "ü•ì", "üßÄ"];
        const el = document.createElement("div");
        el.className = "particle upgrade-particle";
        el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        el.style.left = x + "px";
        el.style.top  = y + "px";
        particlesContainer.appendChild(el);
        setTimeout(() => el.remove(), 900);
    }

    function spawnGoldenParticleCenter() {
        const el = document.createElement("div");
        el.className = "particle golden-particle";
        el.textContent = "üåü";
        el.style.left = (window.innerWidth / 2) + "px";
        el.style.top  = (window.innerHeight / 2 - 80) + "px";
        particlesContainer.appendChild(el);
        setTimeout(() => el.remove(), 900);
    }

    function randomChefSparkle() {
        if (Math.random() < 0.02) {
            const el = document.createElement("div");
            el.className = "particle";
            el.textContent = "‚ú®";
            const rect = burgerEl.getBoundingClientRect();
            el.style.left = (rect.left + rect.width / 2 + (Math.random() * 80 - 40)) + "px";
            el.style.top  = (rect.top  + rect.height/ 2 + (Math.random() * 80 - 40)) + "px";
            particlesContainer.appendChild(el);
            setTimeout(() => el.remove(), 700);
        }
    }

    function getRandomGoldenDelay() {
        const radarCount = shopState.goldenRadar.count || 0;
        goldenSpawnMultiplier = 1 + 0.10 * radarCount; // 10% faster per upgrade
        const min = goldenBaseMinDelay / goldenSpawnMultiplier;
        const max = goldenBaseMaxDelay / goldenSpawnMultiplier;
        return Math.random() * (max - min) + min;
    }

    function spawnGoldenBurgerPopup() {
        if (document.querySelector(".golden-burger-popup")) return;
        const popup = document.createElement("div");
        popup.className = "golden-burger-popup";
        popup.title = "Golden Burger!";

        popup.addEventListener("click", () => {
            const prod = calculateProduction();
            const reward = prod.bps * 30 + prod.bpc * 50 + 500;
            burgers += reward;
            totalBurgersEver += reward;
            spawnGoldenParticleCenter();
            popup.remove();
            updateDisplay();
        });

        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 12000);
    }

// -------- Click handling --------
function handleBurgerClick(event) {
    const now = Date.now();
    
    // Combo Logic
    if (now - lastClickTime < 400) {
        comboCount++;
    } else {
        comboCount = 1;
    }
    lastClickTime = now;
    comboMultiplier = 1 + Math.min(comboCount - 1, 20) * 0.03;

    // Calculate Gains
    const prod = calculateProduction();
    const gain = prod.bpc;
    burgers += gain;
    totalBurgersEver += gain;
    bossRaidProgress += gain;

    // Particles
    const rect = burgerEl.getBoundingClientRect();
    const x = event.clientX || (rect.left + rect.width / 2);
    const y = event.clientY || (rect.top + rect.height / 2);
    spawnClickParticle(x, y);

    // Combat & UI
    attackBossFromClicks(prod.bpc * 0.5);
    updateDisplay();
}


    burgerEl.addEventListener("click", handleBurgerClick);

    // -------- Shop purchase --------
    function buyItem(key, event) {
        const item = shopState[key];
        if (!item || burgers < item.cost) return;

        burgers -= item.cost;
        item.count += 1;
        item.cost = Math.ceil(item.cost * item.costScale);

        if (key === "mutationSerum") {
            if (Math.random() < 0.5) burgersPerClickBase += 5;
            else burgersPerSecondBase += 5;
        } else if (key === "bossSummoner") {
            spawnBoss();
        } else if (key === "prestigeToken") {
            prestigeMultiplier *= 1.10;
        }

        if (key === "goldenRadar") {
            nextGoldenSpawnTime = Date.now() + getRandomGoldenDelay();
        }

        if (countLabelMap[key]) {
            countLabelMap[key].textContent = "Owned: " + item.count;
        }

        const rect = event.target.getBoundingClientRect();
        spawnUpgradeParticle(rect.left + rect.width / 2, rect.top + rect.height / 2);
        updateDisplay();
    }

    Object.entries(buttonMap).forEach(([btnId, key]) => {
        const button = document.getElementById(btnId);
        if (!button) return;
        button.addEventListener("click", e => {
            if (button.classList.contains("disabled")) return;
            buyItem(key, e);
        });
    });

    // -------- Prestige --------
    function ascendPrestige() {
        if (prestigeButton.classList.contains("disabled")) return;

        prestigeAscensions += 1;
        prestigeMultiplier *= 1.25;
    
        // Reset stats
        burgers = 0;
        burgersPerClickBase = 1;
        burgersPerSecondBase = 0;
        bossRaidProgress = 0;

        // FIX: Define base costs to reset the shop prices
        const baseCosts = {
            spatula: 10, grillBot: 25, aiChef: 150, goldenBun: 200, deliveryDrone: 250,
            turboGrill: 600, superSpatula: 800, megaBurger: 3000, aiAssistant: 5000,
            goldenGrill: 9000, deliveryFleet: 12000, mutationSerum: 15000, bossSummoner: 20000,
            prestigeToken: 50000, goldenMutation: 75000, quantumGrill: 150000,
            hyperSpatula: 200000, cosmicDrone: 400000, galacticBun: 600000,
            burgerReactor: 1000000, nanoSpatula: 1500000, goldenRadar: 200000
        };

        // Reset shop counts AND costs
        Object.keys(shopState).forEach(key => {
            shopState[key].count = 0;
            shopState[key].cost = baseCosts[key]; // This resets the price!
            if (countLabelMap[key]) countLabelMap[key].textContent = "Owned: 0";
        });

        updateDisplay();
    }

    prestigeButton.addEventListener("click", ascendPrestige);

    // -------- Orbiting spatulas --------
    function updateOrbitSpatulas() {
        const canvas = document.getElementById("spatulaOrbitCanvas");
        const existing = canvas.querySelectorAll(".orbit-spatula");
        existing.forEach(el => el.remove());

        const aiLevel = shopState.aiChef.count;
        const spatulaCount = Math.min(6, 1 + Math.floor(aiLevel / 2));
        for (let i = 0; i < spatulaCount; i++) {
            const el = document.createElement("div");
            el.className = "orbit-spatula";
            el.dataset.index = i;
            canvas.appendChild(el);
        }
    }

    function animateOrbitSpatulas() {
        const canvas = document.getElementById("spatulaOrbitCanvas");
        const spatulas = canvas.querySelectorAll(".orbit-spatula");
        const aiLevel = shopState.aiChef.count;
        const orbitRadius = 80 + aiLevel * 4;
        const speed = 0.002 + aiLevel * 0.00025;

        const now = Date.now();
        spatulas.forEach(el => {
            const index = Number(el.dataset.index || 0);
            const angle = now * speed + index * (Math.PI * 2 / Math.max(1, spatulas.length));
            const x = Math.cos(angle) * orbitRadius;
            const y = Math.sin(angle) * orbitRadius;
            el.style.transform = "translate(" + x + "px," + y + "px)";
        });
    }

    // -------- Boss / raid --------
    function spawnBoss() {
        if (bossActive) return;
        bossActive = true;
        const prod = calculateProduction();
        bossMaxHealth = 500 + prod.bps * 20 + prod.bpc * 20;
        bossHealth = bossMaxHealth;
        bossStatusEl.textContent = "Boss appeared!";
        updateBossHealthBar();
    }

    function updateBossHealthBar() {
        if (!bossActive) {
            bossHealthBarEl.style.width = "0%";
            bossStatusEl.textContent = "No boss currently.";
            return;
        }
        const pct = Math.max(0, Math.min(100, bossHealth / bossMaxHealth * 100));
        bossHealthBarEl.style.width = pct + "%";
    }

    function attackBossFromClicks(damage) {
        if (!bossActive) return;
        bossHealth -= damage;
        if (bossHealth <= 0) bossDefeated();
        updateBossHealthBar();
    }

    function bossDefeated() {
        bossActive = false;
        bossHealth = 0;
        bossStatusEl.textContent = "Boss defeated!";
        const prod = calculateProduction();
        const reward = prod.bps * 60 + prod.bpc * 100 + 2000;
        burgers += reward;
        totalBurgersEver += reward;
        bossRaidProgress = 0;
        spawnGoldenParticleCenter();
        spawnUpgradeParticle(window.innerWidth / 2, window.innerHeight / 2);
        unlockAchievement("boss_1");
        updateDisplay();
    }

    document.getElementById("forceBossButton").addEventListener("click", () => spawnBoss());

    function updateBossRaidProgress() {
        const pct = Math.max(0, Math.min(100, bossRaidProgress / bossRaidThreshold * 100));
        bossRaidProgressEl.style.width = pct + "%";
        if (!bossActive && bossRaidProgress >= bossRaidThreshold) {
            spawnBoss();
        }
    }

    // -------- Auto tick / offline earnings --------
    function autoTick(dtSeconds) {
        const prod = calculateProduction();
        const gain = prod.bps * dtSeconds;
        burgers += gain;
        totalBurgersEver += gain;
        bossRaidProgress += gain;
    }

    function handleOfflineEarnings() {
        const now = Date.now();
        const diffSeconds = Math.min(60 * 60 * 4, (now - lastOfflineTimestamp) / 1000);
        if (diffSeconds > 1) {
            const prod = calculateProduction();
            const offlineGain = prod.bps * diffSeconds * 0.5;
            burgers += offlineGain;
            totalBurgersEver += offlineGain;
        }
        lastOfflineTimestamp = now;
    }

    // -------- Achievements --------
    function initAchievementsUI() {
        const list = document.getElementById("achievementsList");
        list.innerHTML = "";
        achievements.forEach(a => {
            const row = document.createElement("div");
            row.className = "achievement" + (a.unlocked ? " unlocked" : "");
            row.id = "ach_" + a.id;
            row.textContent = a.name + " ‚Äì " + a.desc;
            list.appendChild(row);
        });
    }

    function unlockAchievement(id) {
        const a = achievements.find(x => x.id === id);
        if (!a || a.unlocked) return;
        a.unlocked = true;
        const row = document.getElementById("ach_" + id);
        if (row) row.classList.add("unlocked");
        const rect = burgerEl.getBoundingClientRect();
        spawnUpgradeParticle(rect.left + rect.width / 2, rect.top);
    }

    function checkAchievements() {
        const prod = calculateProduction();
        if (burgers >= 100)     unlockAchievement("burgers_100");
        if (burgers >= 1000)    unlockAchievement("burgers_1k");
        if (burgers >= 100000)  unlockAchievement("burgers_100k");
        if (prod.bpc >= 100)    unlockAchievement("bpc_100");
        if (prod.bps >= 1000)   unlockAchievement("bps_1k");
        if (prestigeAscensions >= 1) unlockAchievement("ascend_1");
    }

    // -------- Skill tree --------
    function buySkill(key) {
        const skill = skillTreeState[key];
        if (!skill || skill.purchased || burgers < skill.cost) return;
        burgers -= skill.cost;
        skill.purchased = true;
        updateDisplay();
    }

    document.getElementById("buySkillGreasyFingers")
        .addEventListener("click", () => buySkill("greasyFingers"));
    document.getElementById("buySkillIndustrialFans")
        .addEventListener("click", () => buySkill("industrialFans"));
    document.getElementById("buySkillAssemblyLine")
        .addEventListener("click", () => buySkill("assemblyLine"));

    // -------- Username --------
    usernameInput.addEventListener("input", () => {
        username = usernameInput.value.trim();
        updateTitleBar();
    });

    // -------- Golden timer integration --------
    function updateGoldenTimer(now) {
        if (now >= nextGoldenSpawnTime) {
            spawnGoldenBurgerPopup();
            nextGoldenSpawnTime = now + getRandomGoldenDelay();
        }
    }

    // -------- Save / load / export / import --------
    function serializeState() {
        return {
            burgers,
            totalBurgersEver,
            burgersPerClickBase,
            burgersPerSecondBase,
            shopState,
            skillTreeState,
            prestigeAscensions,
            prestigeMultiplier,
            bossRaidProgress,
            username,
            lastOfflineTimestamp: Date.now()
        };
    }

    function deserializeState(data) {
        if (!data) return;
        burgers = data.burgers ?? 0;
        totalBurgersEver = data.totalBurgersEver ?? 0;
        burgersPerClickBase = data.burgersPerClickBase ?? 1;
        burgersPerSecondBase = data.burgersPerSecondBase ?? 0;

        if (data.shopState) {
            Object.keys(shopState).forEach(k => {
                if (data.shopState[k]) {
                    shopState[k].count = data.shopState[k].count ?? 0;
                    shopState[k].cost  = data.shopState[k].cost  ?? shopState[k].cost;
                }
            });
        }

        if (data.skillTreeState) {
            Object.keys(skillTreeState).forEach(k => {
                if (data.skillTreeState[k]) {
                    skillTreeState[k].purchased = !!data.skillTreeState[k].purchased;
                }
            });
        }

        prestigeAscensions   = data.prestigeAscensions ?? 0;
        prestigeMultiplier   = data.prestigeMultiplier ?? 1;
        bossRaidProgress     = data.bossRaidProgress ?? 0;
        username             = data.username ?? "";
        lastOfflineTimestamp = data.lastOfflineTimestamp ?? Date.now();

        Object.keys(countLabelMap).forEach(k => {
            if (countLabelMap[k]) {
                countLabelMap[k].textContent = "Owned: " + (shopState[k].count ?? 0);
            }
        });

        usernameInput.value = username;
        nextGoldenSpawnTime = Date.now() + getRandomGoldenDelay();
        updateDisplay();
    }

    function saveGame() {
        const state = serializeState();
        localStorage.setItem("burgerCapitalismSave", JSON.stringify(state));
    }

    function loadGame() {
        const raw = localStorage.getItem("burgerCapitalismSave");
        if (!raw) return;
        try {
            const data = JSON.parse(raw);
            deserializeState(data);
        } catch (e) {
            console.error(e);
        }
    }

    document.getElementById("saveButton").addEventListener("click", () => saveGame());

    document.getElementById("exportButton").addEventListener("click", () => {
        const code = btoa(unescape(encodeURIComponent(JSON.stringify(serializeState()))));
        document.getElementById("saveCode").value = code;
    });

    document.getElementById("importButton").addEventListener("click", () => {
        const code = document.getElementById("saveCode").value.trim();
        if (!code) return;
        try {
            const decoded = decodeURIComponent(escape(atob(code)));
            const data = JSON.parse(decoded);
            deserializeState(data);
            saveGame();
        } catch (e) {
            console.error(e);
        }
    });

    // -------- Cloud mirror --------
    const CLOUD_SLOT_KEY = "CLOUD_SLOT";

    document.getElementById("cloudSaveButton").addEventListener("click", () => {
        const payload = serializeState();
        localStorage.setItem(CLOUD_SLOT_KEY, JSON.stringify(payload));
        document.getElementById("cloudSlotDisplay").value = JSON.stringify(payload);
    });

    document.getElementById("cloudLoadButton").addEventListener("click", () => {
        const raw = localStorage.getItem(CLOUD_SLOT_KEY);
        if (!raw) return;
        try {
            const data = JSON.parse(raw);
            deserializeState(data);
            document.getElementById("cloudSlotDisplay").value = JSON.stringify(data);
        } catch (e) {
            console.error(e);
        }
    });

    // -------- Leaderboard (local mock) --------
    function updateLeaderboard() {
        const raw = localStorage.getItem("burgerCapitalismLeaderboard");
        let list = [];
        if (raw) {
            try {
                list = JSON.parse(raw);
            } catch (e) {}
        }

        const playerName = username || "Guest";
        const existing = list.find(x => x.name === playerName);
        if (existing) {
            existing.score = Math.max(existing.score, totalBurgersEver);
        } else {
            list.push({name: playerName, score: totalBurgersEver});
        }

        list.sort((a, b) => b.score - a.score);
        list = list.slice(0, 10);
        localStorage.setItem("burgerCapitalismLeaderboard", JSON.stringify(list));
        renderLeaderboard(list);
    }

    function renderLeaderboard(list) {
        leaderboardList.innerHTML = "";
        (list || []).forEach((entry, idx) => {
            const row = document.createElement("div");
            row.className = "leaderboard-entry";
            row.textContent = (idx + 1) + ". " + entry.name + " ‚Äì " + formatNumber(entry.score) + " burgers";
            leaderboardList.appendChild(row);
        });
    }

    function loadLeaderboard() {
        const raw = localStorage.getItem("burgerCapitalismLeaderboard");
        if (!raw) return;
        try {
            const list = JSON.parse(raw);
            renderLeaderboard(list);
            } catch (e) {}
        }

        window.addEventListener("beforeunload", () => {
            saveGame();
            updateLeaderboard();

        function renderLeaderboard() {
        const listEl = document.getElementById("leaderboardList");
        const scores = JSON.parse(localStorage.getItem('burgerLeaderboard') || '[]');
    
        if (scores.length === 0) {
            listEl.innerHTML = "<p>No entries yet!</p>";
            return;
        }

        listEl.innerHTML = scores.map((entry, index) => `
            <div class="leaderboard-entry" style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.05); padding: 4px 0;">
                <span>${index + 1}. ${entry.name}</span>
                <span style="color:#ffe082;">${formatNumber(entry.score)}</span>
            </div>
        `).join('');
    }
    });

    // -------- Main loop --------
    function gameLoop() {
        const now = Date.now();
        const dt = (now - lastTickTime) / 1000;
        lastTickTime = now;

        if (dt > 0) {
            autoTick(dt);
        }

        animateOrbitSpatulas();
        randomChefSparkle();
        checkAchievements();
        updateGoldenTimer(now);
        updateDisplay();

        requestAnimationFrame(gameLoop);
    }

    function init() {
        loadGame();
        loadLeaderboard();
        initAchievementsUI();
        handleOfflineEarnings();
        updateDisplay();
        gameLoop();
    }

    init();
/* =========================
   EXPANSION LAYER ‚Äî PART 1
   Add-only patch ‚Äî no deletions
========================= */

// ---------- Large Emoji Burger + Pulse Override ----------
(function(){
    const oldBurger = document.getElementById("burger");
    if (!oldBurger) return;

    const wrap = oldBurger.parentElement;

    const emojiBtn = document.createElement("div");
    emojiBtn.id = "burgerEmojiButton";
    emojiBtn.textContent = "üçî";
    emojiBtn.style.fontSize = "110px";
    emojiBtn.style.cursor = "pointer";
    emojiBtn.style.textAlign = "center";
    emojiBtn.style.marginTop = "10px";
    emojiBtn.style.transition = "transform 0.15s ease";
    emojiBtn.style.animation = "burgerPulse 1.4s infinite";

    const style = document.createElement("style");
    style.innerHTML = `
    @keyframes burgerPulse {
        0% { transform: scale(1); filter: drop-shadow(0 0 0px gold);}
        50% { transform: scale(1.08); filter: drop-shadow(0 0 16px gold);}
        100% { transform: scale(1); filter: drop-shadow(0 0 0px gold);}
    }`;
    document.head.appendChild(style);

    emojiBtn.onclick = (e)=> oldBurger.click();

    wrap.appendChild(emojiBtn);
})();


// ---------- Buy 1 / 10 / 100 Controls ----------
(function(){
    const shopItems = document.querySelectorAll(".shop-item");
    shopItems.forEach(row=>{
        const btn = row.querySelector("button");
        if (!btn) return;

        const box = document.createElement("div");
        box.style.display = "flex";
        box.style.gap = "4px";

        [1,10,100].forEach(q=>{
            const b = document.createElement("button");
            b.textContent = "√ó"+q;
            b.className = "btn secondary";
            b.style.padding="4px 6px";
            b.onclick = (e)=>{
                e.stopPropagation();
                if (!btn.id) return;
                const key = buttonMap[btn.id];
                if (!key) return;

                buyBulk(key,q,e);
            };
            box.appendChild(b);
        });

        row.appendChild(box);
    });
})();

function bulkCost(item, qty){
    let cost = 0;
    let c = item.cost;
    for(let i=0;i<qty;i++){
        cost += c;
        c = Math.ceil(c * item.costScale);
    }
    return cost;
}

function buyBulk(key, qty, event){
    const item = shopState[key];
    if (!item) return;

    const total = bulkCost(item, qty);
    if (burgers < total) return;

    burgers -= total;

    for(let i=0;i<qty;i++){
        item.count++;
        item.cost = Math.ceil(item.cost * item.costScale);
    }

    if (countLabelMap[key]) {
        countLabelMap[key].textContent = "Owned: " + item.count;
    }

    spawnUpgradeParticle(event.clientX, event.clientY);
    updateDisplay();
}


// ---------- Ascension Requirement Rewrite ----------
let ascendRequirementBase = 25000;

function getAscendRequirement(){
    return ascendRequirementBase * Math.pow(2, prestigeAscensions);
}

function getAscendBonus(){
    return 1 + Math.max(0.10, Math.log10(totalBurgersEver+10)/20);
}

function updatePrestigeButton(){
    const req = getAscendRequirement();
    if (totalBurgersEver >= req){
        prestigeButton.classList.remove("disabled");
    } else {
        prestigeButton.classList.add("disabled");
    }
    prestigeButton.textContent =
        "Ascend (+" + ((getAscendBonus()-1)*100).toFixed(0) +
        "%) need " + formatNumber(req);
}

const oldAscend = ascendPrestige;
ascendPrestige = function(){
    if (prestigeButton.classList.contains("disabled")) return;

    const mult = getAscendBonus();
    prestigeMultiplier *= mult;
    prestigeAscensions++;

    oldAscend();
};


// ---------- Dual Golden Burger System ----------
let goldenBoostActive = false;
let goldenBoostEnd = 0;

function spawnGoldenBurgerPopup(){
    if (document.querySelector(".golden-burger-popup")) return;

    const type = Math.random()<0.35 ? "boost" : "reward";

    const popup = document.createElement("div");
    popup.className = "golden-burger-popup";

    if (type==="boost"){
        popup.textContent="üöÄ";
        popup.style.background="radial-gradient(circle,#bbdefb,#1e88e5)";
    } else {
        popup.textContent="üí∞";
    }

    popup.onclick = ()=>{
        if (type==="reward"){
            const prod = calculateProduction();
            const reward = prod.bps*45 + prod.bpc*60 + 1000;
            burgers += reward;
            totalBurgersEver += reward;
        } else {
            goldenBoostActive = true;
            goldenBoostEnd = Date.now()+60000;
        }
        popup.remove();
    };

    document.body.appendChild(popup);
    setTimeout(()=>popup.remove(),10000);
}


// ---------- Golden Boost Production Hook ----------
const oldCalc = calculateProduction;
calculateProduction = function(){
    const p = oldCalc();
    if (goldenBoostActive){
        p.bpc *= 1.25;
        p.bps *= 1.25;
    }
    if (goldenBoostActive && Date.now()>goldenBoostEnd){
        goldenBoostActive=false;
    }
    return p;
};


// ---------- Boss Types ----------
const bossTypes = [
    {name:"Wolf", emoji:"üê∫", hp:1.2, reward:1.2},
    {name:"Pigeon", emoji:"üïäÔ∏è", hp:0.8, reward:0.8},
    {name:"Mouse", emoji:"üê≠", hp:0.6, reward:0.7},
    {name:"Human", emoji:"üßë", hp:1.5, reward:1.5}
];

let currentBossType = null;

const oldSpawnBoss = spawnBoss;
spawnBoss = function(){
    if (bossActive) return;
    currentBossType = bossTypes[Math.floor(Math.random()*bossTypes.length)];

    oldSpawnBoss();
    bossMaxHealth *= currentBossType.hp;
    bossHealth = bossMaxHealth;

    bossStatusEl.textContent =
        currentBossType.emoji+" "+currentBossType.name+" Boss!";
};

const oldBossDefeated = bossDefeated;
bossDefeated = function(){
    if (currentBossType){
        burgers *= currentBossType.reward;
    }
    oldBossDefeated();
};


// ---------- Leaderboard Stability Fix ----------
updateLeaderboard = function(){
    const key="burgerCapitalismLeaderboard";
    let list=[];
    try{ list=JSON.parse(localStorage.getItem(key)||"[]"); }catch{}

    const name = username || "Guest";

    const now=Date.now();
    list.push({name,score:totalBurgersEver,time:now});

    const best={};
    list.forEach(e=>{
        if (!best[e.name] || best[e.name].score<e.score){
            best[e.name]=e;
        }
    });

    const final = Object.values(best)
        .sort((a,b)=> b.score-a.score || a.time-b.time)
        .slice(0,10);

    localStorage.setItem(key, JSON.stringify(final));
    renderLeaderboard(final);
};


// ---------- Bug guard fixes ----------
window.addEventListener("error", e=>{
    console.log("Guarded error:", e.message);
});

/* =========================
   EXPANSION LAYER ‚Äî PART 2
   Shop + Skills + Scaling
========================= */


// -------- Massive Late Game Shop Ladder (data-driven) --------

const lateGameShopAdditions = [
 {key:"fusionGrill", name:"Fusion Grill", cost:2e6, bps:1200, bpc:0, scale:1.28},
 {key:"plasmaSpatula", name:"Plasma Spatula", cost:5e6, bps:0, bpc:900, scale:1.28},
 {key:"burgerLab", name:"Burger Lab", cost:1e7, bps:3500, bpc:0, scale:1.30},
 {key:"darkKitchen", name:"Dark Kitchen", cost:2e7, bps:8000, bpc:0, scale:1.30},
 {key:"quantumChef", name:"Quantum Chef", cost:5e7, bps:0, bpc:4000, scale:1.30},
 {key:"factoryCity", name:"Factory City", cost:1e8, bps:20000, bpc:0, scale:1.32},
 {key:"burgerAICluster", name:"AI Cluster", cost:2e8, bps:45000, bpc:0, scale:1.32},
 {key:"orbitGrillRing", name:"Orbit Grill Ring", cost:5e8, bps:100000, bpc:0, scale:1.34},
 {key:"moonKitchen", name:"Moon Kitchen", cost:1e9, bps:250000, bpc:0, scale:1.35},
 {key:"planetaryChain", name:"Planetary Chain", cost:2e9, bps:600000, bpc:0, scale:1.36},
 {key:"starForge", name:"Star Forge", cost:5e9, bps:1200000, bpc:0, scale:1.36},
 {key:"galaxyFranchise", name:"Galaxy Franchise", cost:1e10, bps:2500000, bpc:0, scale:1.37},
 {key:"voidKitchen", name:"Void Kitchen", cost:2e10, bps:6000000, bpc:0, scale:1.38},
 {key:"timelineGrill", name:"Timeline Grill", cost:5e10, bps:15000000, bpc:0, scale:1.38},
 {key:"multiverseChain", name:"Multiverse Chain", cost:1e11, bps:40000000, bpc:0, scale:1.39},
 {key:"realityBakery", name:"Reality Bakery", cost:2e11, bps:90000000, bpc:0, scale:1.40},
 {key:"cosmicFoundry", name:"Cosmic Foundry", cost:5e11, bps:250000000, bpc:0, scale:1.40},
 {key:"infiniteDrive", name:"Infinite Drive", cost:1e12, bps:1000000, bpc:1000000, scale:1.42}
];

(function registerLateGameShop(){

    const shopWrap = document.getElementById("shopItems");
    if (!shopWrap) return;

    lateGameShopAdditions.forEach(def=>{

        if (shopState[def.key]) return;

        shopState[def.key] = {
            count:0,
            cost:def.cost,
            bpc:def.bpc,
            bps:def.bps,
            costScale:def.scale
        };

        const row = document.createElement("div");
        row.className="shop-item";

        const info = document.createElement("div");
        info.className="item-info";

        const title = document.createElement("div");
        title.className="item-title";
        title.textContent = def.name +
            (def.bps? " (+"+formatNumber(def.bps)+" /s)" :
             " (+"+formatNumber(def.bpc)+" /click)");

        const count = document.createElement("div");
        count.className="item-count";
        count.textContent="Owned: 0";

        info.appendChild(title);
        info.appendChild(count);

        const btn = document.createElement("button");
        const btnId = "buy_"+def.key;
        btn.id = btnId;
        btn.className="btn";
        btn.textContent="Buy ("+formatNumber(def.cost)+")";

        buttonMap[btnId]=def.key;
        countLabelMap[def.key]=count;

        btn.onclick = e=>{
            if (btn.classList.contains("disabled")) return;
            buyItem(def.key,e);
        };

        row.appendChild(info);
        row.appendChild(btn);

        shopWrap.appendChild(row);
    });

})();


// -------- Extended Skill Tree --------

const extraSkills = [
 {id:"comboMastery", name:"Combo Mastery", cost:15000, click:0.15, auto:0},
 {id:"goldenLuck", name:"Golden Luck", cost:20000, click:0, auto:0},
 {id:"bossBreaker", name:"Boss Breaker", cost:30000, click:0.20, auto:0},
 {id:"autoOverdrive", name:"Auto Overdrive", cost:45000, click:0, auto:0.20},
 {id:"ascendAmplifier", name:"Ascend Amplifier", cost:60000, click:0, auto:0},
 {id:"goldenDuration", name:"Golden Duration", cost:80000, click:0, auto:0}
];

extraSkills.forEach(s=>{
    skillTreeState[s.id]={
        purchased:false,
        cost:s.cost,
        clickBonus:s.click,
        autoBonus:s.auto
    };
});

(function buildExtraSkillUI(){

    const tree = document.getElementById("skillTree");
    if (!tree) return;

    extraSkills.forEach(s=>{
        const row = document.createElement("div");
        row.className="skill-node";

        const info = document.createElement("div");
        info.className="item-info";

        const t = document.createElement("div");
        t.className="item-title";
        t.textContent = s.name;

        const m = document.createElement("div");
        m.className="item-meta";
        m.textContent = "Cost: "+formatNumber(s.cost);

        info.appendChild(t);
        info.appendChild(m);

        const btn = document.createElement("button");
        btn.className="btn secondary";
        btn.textContent="Unlock";

        btn.onclick = ()=> buySkill(s.id);

        row.appendChild(info);
        row.appendChild(btn);
        tree.appendChild(row);
    });

})();


// -------- Skill Hooks --------

const oldComboCapCalc = comboMultiplier;
function getComboCap(){
    return skillTreeState.comboMastery?.purchased ? 60 : 20;
}

const oldHandleClick = handleBurgerClick;
handleBurgerClick = function(e){
    oldHandleClick(e);
    comboMultiplier = 1 + Math.min(comboCount-1, getComboCap())*0.03;
};


// Golden luck skill affects spawn timing
const oldGetGoldenDelay = getRandomGoldenDelay;
getRandomGoldenDelay = function(){
    let d = oldGetGoldenDelay();
    if (skillTreeState.goldenLuck?.purchased) d *= 0.7;
    return d;
};


// Boss breaker skill ‚Üí more click damage
const oldAttackBoss = attackBossFromClicks;
attackBossFromClicks = function(dmg){
    if (skillTreeState.bossBreaker?.purchased){
        dmg *= 1.5;
    }
    oldAttackBoss(dmg);
};


// Ascend amplifier skill
const oldGetAscendBonusFn = getAscendBonus;
getAscendBonus = function(){
    let b = oldGetAscendBonusFn();
    if (skillTreeState.ascendAmplifier?.purchased){
        b += 0.05;
    }
    return b;
};


// Golden duration skill
const oldSpawnGolden = spawnGoldenBurgerPopup;
spawnGoldenBurgerPopup = function(){
    oldSpawnGolden();
    if (skillTreeState.goldenDuration?.purchased){
        goldenBoostEnd += 30000;
    }
};


// -------- Production Softcap Balancer --------

function lateGameSoftcap(x){
    if (x < 1e7) return x;
    return 1e7 * Math.pow(x/1e7, 0.92);
}

const oldAutoTickFn = autoTick;
autoTick = function(dt){
    const before = burgers;
    oldAutoTickFn(dt);
    const gained = burgers - before;
    const adjusted = lateGameSoftcap(gained);
    burgers = before + adjusted;
};


// -------- Number Formatting Upgrade --------

const suffixes = [
 "","K","M","B","T","Qa","Qi","Sx","Sp","Oc","No","Dc"
];

formatNumber = function(n){
    if (n<1000) return Math.floor(n).toString();
    let i = Math.floor(Math.log10(n)/3);
    i = Math.min(i, suffixes.length-1);
    return (n/Math.pow(1000,i)).toFixed(2)+suffixes[i];
};


// -------- Shop Button Refresh Hook --------

const oldUpdateShopButtons = updateShopButtons;
updateShopButtons = function(){
    oldUpdateShopButtons();
    Object.entries(buttonMap).forEach(([id,key])=>{
        const btn=document.getElementById(id);
        const item=shopState[key];
        if (!btn||!item) return;
        btn.textContent="Buy ("+formatNumber(item.cost)+")";
    });
};


// -------- Save Compatibility Patch --------

const oldSerialize = serializeState;
serializeState = function(){
    const s = oldSerialize();
    s.lateGameShop = lateGameShopAdditions.map(d=>({
        key:d.key,
        count:shopState[d.key]?.count||0,
        cost:shopState[d.key]?.cost||d.cost
    }));
    return s;
};

const oldDeserialize = deserializeState;
deserializeState = function(data){
    oldDeserialize(data);
    if (data.lateGameShop){
        data.lateGameShop.forEach(e=>{
            if (shopState[e.key]){
                shopState[e.key].count=e.count;
                shopState[e.key].cost=e.cost;
                if (countLabelMap[e.key]){
                    countLabelMap[e.key].textContent="Owned: "+e.count;
                }
            }
        });
    }
};


/* =========================
   EXPANSION LAYER ‚Äî PART 3
   Visual + UI + Final Systems
========================= */


// -------- Big Emoji Burger + Pulse Fix --------

(function upgradeBurgerVisual(){

    const btn = document.getElementById("burgerButton");
    if (!btn) return;

    btn.textContent = "üçî";
    btn.style.fontSize = "110px";
    btn.style.lineHeight = "1";
    btn.style.borderRadius = "24px";
    btn.style.background = "none";
    btn.style.boxShadow = "none";

    if (!document.getElementById("burgerPulseStyle")){
        const s = document.createElement("style");
        s.id="burgerPulseStyle";
        s.textContent = `
        @keyframes burgerPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }
        #burgerButton {
            animation: burgerPulse 1.2s infinite;
        }
        `;
        document.head.appendChild(s);
    }

})();


// -------- Click Feedback Scale (fix missing pulse feedback) --------

const oldClickAnim = spawnClickText;
spawnClickText = function(x,y,val){
    oldClickAnim(x,y,val);
    const b = document.getElementById("burgerButton");
    if (!b) return;
    b.style.transform="scale(1.18)";
    setTimeout(()=>b.style.transform="scale(1)",120);
};


// -------- Buy 1 / 10 / 100 System --------

let buyAmount = 1;

(function buildBuyAmountUI(){

    const shop = document.getElementById("shopPanel");
    if (!shop) return;

    const row = document.createElement("div");
    row.style.display="flex";
    row.style.gap="6px";
    row.style.marginBottom="8px";

    [1,10,100].forEach(n=>{
        const b=document.createElement("button");
        b.className="btn secondary";
        b.textContent="Buy x"+n;
        b.onclick=()=>{ buyAmount=n; highlightBuyAmount(n,row); };
        row.appendChild(b);
    });

    shop.prepend(row);
    highlightBuyAmount(1,row);

})();

function highlightBuyAmount(n,row){
    [...row.children].forEach(c=>{
        c.style.outline =
            c.textContent === "Buy x"+n
            ? "2px solid gold"
            : "none";
    });
}



// -------- Bulk Cost Calculator --------

function bulkCost(item, amount){
    let total=0;
    let c=item.cost;
    for (let i=0;i<amount;i++){
        total+=c;
        c*=item.costScale||1.15;
    }
    return total;
}


// -------- Patch buyItem for bulk --------

const oldBuyItemFn = buyItem;
buyItem = function(key,e){
    const item = shopState[key];
    if (!item) return;

    const amt = buyAmount||1;
    const cost = bulkCost(item, amt);
    if (burgers < cost) return;

    burgers -= cost;

    for (let i=0;i<amt;i++){
        item.count++;
        item.cost *= item.costScale||1.15;
    }

    if (countLabelMap[key]){
        countLabelMap[key].textContent="Owned: "+item.count;
    }

    updateShopButtons();
};



// -------- Golden Burger Spawn Tuning --------

const oldGoldenScheduler = scheduleNextGolden;
scheduleNextGolden = function(){
    // rarer base
    const base = 45000 + Math.random()*90000;

    // skill bonus still applies
    const mult = skillTreeState.goldenLuck?.purchased ? 0.75 : 1;

    setTimeout(spawnGoldenBurgerPopup, base*mult);
};


// -------- Golden Popup Visual Upgrade --------

const prevGoldenPopup = spawnGoldenBurgerPopup;
spawnGoldenBurgerPopup = function(){
    prevGoldenPopup();

    const g = document.querySelector(".golden-burger-popup");
    if (!g) return;

    g.style.fontSize="42px";
    g.style.boxShadow="0 0 18px gold";
    g.style.border="3px solid #ffd54f";
};


// -------- Ascension Requirement Gate --------

function getAscendRequirement(){
    // scales with progress ‚Äî prevents early spam
    return Math.max(1e5, Math.pow(totalBurgersEver+1,0.72));
}

const oldUpdatePrestigeBtn2 = updatePrestigeButton;
updatePrestigeButton = function(){
    oldUpdatePrestigeBtn2();
    const req = getAscendRequirement();
    prestigeButton.title = "Need "+formatNumber(req)+" lifetime burgers";
};


// -------- Ascension Reset Safety --------

const oldAscend2 = ascendPrestige;
ascendPrestige = function(){
    if (totalBurgersEver < getAscendRequirement()) return;
    updateLeaderboard();
    oldAscend2();
};


// -------- Boss Reward Balance --------

const oldBossReward = bossDefeated;
bossDefeated = function(){
    const before = burgers;
    oldBossReward();
    const gain = burgers-before;

    // clamp extreme multipliers
    if (gain > calculateProduction().bps*600){
        burgers = before + calculateProduction().bps*600;
    }
};


// -------- Leaderboard Auto Refresh --------

setInterval(()=>{
    if (document.getElementById("leaderboardPanel")?.offsetParent!==null){
        updateLeaderboard();
    }
}, 30000);


// -------- UI Number Refresh Stability --------

const oldUpdateUIFn = updateUI;
updateUI = function(){
    oldUpdateUIFn();
    const el=document.getElementById("burgerCount");
    if (el) el.textContent = formatNumber(burgers);
};


// -------- Combo Drift Fix --------

setInterval(()=>{
    if (comboCount<=0){
        comboCount=0;
        comboMultiplier=1;
    }
},2000);


// -------- Golden Boost Expire Guard --------

setInterval(()=>{
    if (goldenBoostActive && Date.now()>goldenBoostEnd){
        goldenBoostActive=false;
    }
},1000);


// -------- Animation Frame Leak Guard --------

let lastFrame=0;
const oldGameLoop = gameLoop;
gameLoop = function(ts){
    if (ts-lastFrame>1000){
        lastFrame=ts;
    }
    oldGameLoop(ts);
};

// -------- NEW SKILL TREE SYSTEM --------

// Define the skills
const skillTreeState = {
    greasyFingers:  {purchased: false, cost: 2000,  clickBonus: 0.05, autoBonus: 0},
    industrialFans: {purchased: false, cost: 2000,  clickBonus: 0,    autoBonus: 0.05},
    extraPickles:   {purchased: false, cost: 10000, clickBonus: 0.10, autoBonus: 0},
    conveyorBelt:   {purchased: false, cost: 25000, clickBonus: 0,    autoBonus: 0.15}
};

// Function to buy skills
window.buySkill = function(key) {
    const skill = skillTreeState[key];
    if (skill.purchased || burgers < skill.cost) return;
    
    burgers -= skill.cost;
    skill.purchased = true;
    
    // Visual update
    const el = document.getElementById('skill-' + key);
    if (el) el.classList.add('bought');
    
    updateDisplay();
};

// -------- GLOBAL LEADERBOARD FIX --------
window.updateLeaderboard = async function() {
    const name = document.getElementById("usernameInput")?.value || "Player";
    const score = totalBurgersEver;
    
    // Local leaderboard simulation (replaces the broken system)
    let board = JSON.parse(localStorage.getItem("burger_leaderboard") || "[]");
    board.push({name, score, id: Math.random()});
    board.sort((a,b) => b.score - a.score);
    board = board.slice(0, 8); // Top 8
    localStorage.setItem("burger_leaderboard", JSON.stringify(board));

    const container = document.getElementById("leaderboardList");
    if (container) {
        container.innerHTML = board.map(e => `<div>${e.name}: ${formatNumber(e.score)}</div>`).join("");
    }
};
// -------- Final Safety Guards --------

window.addEventListener("unhandledrejection", e=>{
    console.log("Promise guarded:", e.reason);
});

console.log("Expansion Layer Part 3 Loaded");

// -------- RESTART PROGRESS LOGIC --------
document.getElementById("restartButton").addEventListener("click", () => {
    if (confirm("Are you sure you want to RESTART? This will wipe all progress, including Prestige!")) {
        localStorage.clear();
        location.reload(); // Refreshes page to starting state
    }
});

// -------- FIXED ASCENSION LOGIC --------
function ascendPrestige() {
    if (prestigeButton.classList.contains("disabled")) return;

    // Increment Prestige
    prestigeAscensions += 1;
    prestigeMultiplier *= 1.10;

    // Reset Core Stats
    burgers = 0;
    burgersPerClickBase = 1;
    burgersPerSecondBase = 0;
    bossRaidProgress = 0;
    comboCount = 0;
    comboMultiplier = 1;

    // CRITICAL: Reset Shop Counts AND Costs
    // This was likely why it "didn't work" before
    // CRITICAL: Reset Shop Counts AND Costs
    const originalCosts = {
        spatula: 10, grillBot: 25, aiChef: 150, goldenBun: 200, deliveryDrone: 250,
        turboGrill: 600, superSpatula: 800, megaBurger: 3000, aiAssistant: 5000,
        goldenGrill: 9000, deliveryFleet: 12000, mutationSerum: 15000, bossSummoner: 20000,
        prestigeToken: 50000, goldenMutation: 75000, quantumGrill: 150000,
        hyperSpatula: 200000, cosmicDrone: 400000, galacticBun: 600000,
        burgerReactor: 1000000, nanoSpatula: 1500000, goldenRadar: 2000000,
        // --- Added 15 New High-Tier Items ---
        fusionGrill: 5000000,
        antimatterBun: 15000000,
        orbitalKitchen: 50000000,
        timeFryer: 150000000,
        blackHoleOven: 500000000,
        nebulaSpatula: 1000000000,
        dimensionKetchup: 5000000000,
        quantumCow: 15000000000,
        galaxyDriveThru: 50000000000,
        starDustSeason: 120000000000,
        voidMeat: 250000000000,
        infinityGrill: 450000000000,
        universalChef: 650000000000,
        realityBake: 850000000000,
        capitalismGod: 1000000000000
    };

    Object.keys(shopState).forEach(key => {
        shopState[key].count = 0;
        shopState[key].cost = originalCosts[key] || 10;
        if (countLabelMap[key]) {
            countLabelMap[key].textContent = "Owned: 0";
        }
    });

    // Reset Skills
    Object.values(skillTreeState).forEach(skill => {
        skill.purchased = false;
    });

    alert("You have ascended! Your production is now 10% stronger.");
    updateDisplay();
}

// Re-bind the click event to our fixed function
prestigeButton.onclick = ascendPrestige;

init();
})();
</script>
</body>
</html>
